import React, { useEffect, useState } from 'react';
import {\n  View,\n  Text,\n  StyleSheet,\n  ScrollView,\n  TouchableOpacity,\n  Dimensions,\n  Platform,\n  StatusBar,\n  RefreshControl,\n  ActivityIndicator,\n} from 'react-native';\nimport { SafeAreaView } from 'react-native-safe-area-context';\nimport { router } from 'expo-router';\nimport {\n  Brain,\n  Zap,\n  Target,\n  BookOpen,\n  Clock,\n  Star,\n  Award,\n  Sparkles,\n  Users,\n  Trophy,\n  Swords,\n  Play,\n  Settings,\n  Filter,\n  Shuffle,\n} from 'lucide-react-native';\nimport { LinearGradient } from 'expo-linear-gradient';\nimport Card from '@/components/Card';\nimport EnhancedQuestionDatabase, {\n  BharatKoshQuestion,\n  DifficultyLevel,\n  UserPerformance,\n} from '@/services/question-database';\n\nconst { width } = Dimensions.get('window');\n\ninterface PracticeMode {\n  id: string;\n  title: string;\n  description: string;\n  icon: React.ReactNode;\n  gradient: string[];\n  features: string[];\n  onPress: () => void;\n}\n\ninterface TopicStats {\n  topic: string;\n  questionsCount: number;\n  accuracy: number;\n  difficulty: DifficultyLevel;\n  masteryLevel: string;\n}\n\nexport default function EnhancedPracticeScreen() {\n  const [questionStats, setQuestionStats] = useState<any>(null);\n  const [userPerformance, setUserPerformance] = useState<UserPerformance | null>(null);\n  const [topicStats, setTopicStats] = useState<TopicStats[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [refreshing, setRefreshing] = useState(false);\n  const [selectedDifficulty, setSelectedDifficulty] = useState<DifficultyLevel | 'all'>('all');\n\n  const loadPracticeData = async () => {\n    try {\n      setLoading(true);\n      \n      // Load question statistics\n      const qStats = await EnhancedQuestionDatabase.getQuestionStats();\n      setQuestionStats(qStats);\n      \n      // Load user performance\n      const performance = await EnhancedQuestionDatabase.getUserPerformance('default_user');\n      setUserPerformance(performance);\n      \n      // Process topic statistics\n      if (qStats?.byTopic && performance) {\n        const topics = Object.entries(qStats.byTopic).map(([topic, count]) => {\n          const topicPerf = performance.topicWisePerformance[topic];\n          return {\n            topic,\n            questionsCount: count as number,\n            accuracy: topicPerf?.accuracy || 0,\n            difficulty: topicPerf?.averageDifficulty || 'easy',\n            masteryLevel: topicPerf?.masteryLevel || 'beginner',\n          };\n        }).sort((a, b) => b.questionsCount - a.questionsCount);\n        \n        setTopicStats(topics);\n      }\n    } catch (error) {\n      console.error('Failed to load practice data:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const onRefresh = async () => {\n    setRefreshing(true);\n    await loadPracticeData();\n    setRefreshing(false);\n  };\n\n  const startAIAdaptiveTest = async () => {\n    const questions = await EnhancedQuestionDatabase.generateAdaptiveTest('default_user', 10);\n    router.push({\n      pathname: '/quiz',\n      params: { mode: 'ai', questions: JSON.stringify(questions) }\n    });\n  };\n\n  const startQuickPractice = async () => {\n    const questions = await EnhancedQuestionDatabase.getRandomQuestions({\n      count: 10,\n      difficulty: selectedDifficulty !== 'all' ? selectedDifficulty : undefined,\n    });\n    router.push({\n      pathname: '/quiz',\n      params: { mode: 'quick', questions: JSON.stringify(questions) }\n    });\n  };\n\n  const startTopicPractice = (topic: string) => {\n    router.push({\n      pathname: '/quiz',\n      params: { mode: 'topic', topic, difficulty: selectedDifficulty }\n    });\n  };\n\n  const startTimedChallenge = async () => {\n    const questions = await EnhancedQuestionDatabase.getRandomQuestions({\n      count: 20,\n      difficulty: selectedDifficulty !== 'all' ? selectedDifficulty : undefined,\n    });\n    router.push({\n      pathname: '/quiz',\n      params: { mode: 'timed', questions: JSON.stringify(questions), timeLimit: 1200 } // 20 minutes\n    });\n  };\n\n  const getMasteryColor = (level: string): string => {\n    const colors: Record<string, string> = {\n      beginner: '#FF6B6B',\n      intermediate: '#FFD93D',\n      advanced: '#4ECDC4',\n      expert: '#45B7D1',\n    };\n    return colors[level] || '#95A5A6';\n  };\n\n  const getDifficultyColor = (difficulty: DifficultyLevel): string => {\n    const colors: Record<DifficultyLevel, string> = {\n      easy: '#4ECDC4',\n      medium: '#FFD93D',\n      hard: '#FF6B6B',\n    };\n    return colors[difficulty];\n  };\n\n  const practiceAodes: PracticeMode[] = [\n    {\n      id: 'ai',\n      title: 'AI Adaptive Test',\n      description: 'Questions tailored to your performance and learning gaps',\n      icon: <Brain size={24} color=\"#FFFFFF\" />,\n      gradient: ['#667eea', '#764ba2'],\n      features: ['Personalized difficulty', 'AI-powered insights', 'Performance tracking'],\n      onPress: startAIAdaptiveTest,\n    },\n    {\n      id: 'quick',\n      title: 'Quick Practice',\n      description: 'Random mix of questions from all topics',\n      icon: <Zap size={24} color=\"#FFFFFF\" />,\n      gradient: ['#4ECDC4', '#44A08D'],\n      features: ['10 questions', 'Mixed topics', 'Instant feedback'],\n      onPress: startQuickPractice,\n    },\n    {\n      id: 'timed',\n      title: 'Timed Challenge',\n      description: '20 questions in 20 minutes - test your speed and accuracy',\n      icon: <Clock size={24} color=\"#FFFFFF\" />,\n      gradient: ['#FF6B35', '#F7931E'],\n      features: ['Time pressure', '20 questions', 'Leaderboard'],\n      onPress: startTimedChallenge,\n    },\n  ];\n\n  useEffect(() => {\n    loadPracticeData();\n  }, []);\n\n  if (loading) {\n    return (\n      <SafeAreaView style={styles.container}>\n        <View style={styles.loadingContainer}>\n          <ActivityIndicator size=\"large\" color=\"#667eea\" />\n          <Text style={styles.loadingText}>Loading practice options...</Text>\n        </View>\n      </SafeAreaView>\n    );\n  }\n\n  return (\n    <SafeAreaView style={styles.container}>\n      <StatusBar barStyle=\"dark-content\" backgroundColor=\"#F8FAFC\" />\n      <ScrollView\n        style={styles.scrollView}\n        showsVerticalScrollIndicator={false}\n        refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}\n      >\n        {/* Header */}\n        <LinearGradient\n          colors={['#667eea', '#764ba2']}\n          start={{ x: 0, y: 0 }}\n          end={{ x: 1, y: 1 }}\n          style={styles.headerGradient}\n        >\n          <View style={styles.header}>\n            <Text style={styles.headerTitle}>Practice Hub</Text>\n            <Text style={styles.headerSubtitle}>\n              Master Indian History with AI-powered practice\n            </Text>\n            \n            <View style={styles.statsRow}>\n              <View style={styles.statItem}>\n                <Text style={styles.statNumber}>{questionStats?.total?.toLocaleString() || '0'}</Text>\n                <Text style={styles.statLabel}>Total Questions</Text>\n              </View>\n              <View style={styles.statDivider} />\n              <View style={styles.statItem}>\n                <Text style={styles.statNumber}>\n                  {questionStats?.byTopic ? Object.keys(questionStats.byTopic).length : 0}\n                </Text>\n                <Text style={styles.statLabel}>Topics</Text>\n              </View>\n              <View style={styles.statDivider} />\n              <View style={styles.statItem}>\n                <Text style={styles.statNumber}>\n                  {userPerformance?.overallAccuracy?.toFixed(0) || '0'}%\n                </Text>\n                <Text style={styles.statLabel}>Your Accuracy</Text>\n              </View>\n            </View>\n          </View>\n        </LinearGradient>\n\n        {/* Difficulty Filter */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Choose Difficulty</Text>\n          <View style={styles.difficultySelector}>\n            {(['all', 'easy', 'medium', 'hard'] as const).map((difficulty) => (\n              <TouchableOpacity\n                key={difficulty}\n                style={[\n                  styles.difficultyButton,\n                  selectedDifficulty === difficulty && styles.difficultyButtonActive\n                ]}\n                onPress={() => setSelectedDifficulty(difficulty)}\n              >\n                <Text style={[\n                  styles.difficultyText,\n                  selectedDifficulty === difficulty && styles.difficultyTextActive\n                ]}>\n                  {difficulty === 'all' ? 'All Levels' : difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}\n                </Text>\n              </TouchableOpacity>\n            ))}\n          </View>\n        </View>\n\n        {/* Practice Modes */}\n        <View style={styles.section}>\n          <View style={styles.sectionHeader}>\n            <Sparkles size={20} color=\"#667eea\" />\n            <Text style={styles.sectionTitle}>Practice Modes</Text>\n          </View>\n\n          {practiceAodes.map((mode) => (\n            <TouchableOpacity key={mode.id} style={styles.modeCard} onPress={mode.onPress}>\n              <LinearGradient\n                colors={mode.gradient}\n                style={styles.modeGradient}\n              >\n                <View style={styles.modeHeader}>\n                  <View style={styles.modeIcon}>{mode.icon}</View>\n                  <View style={styles.modeContent}>\n                    <Text style={styles.modeTitle}>{mode.title}</Text>\n                    <Text style={styles.modeDescription}>{mode.description}</Text>\n                  </View>\n                  <TouchableOpacity style={styles.playButton}>\n                    <Play size={16} color=\"#667eea\" fill=\"#667eea\" />\n                  </TouchableOpacity>\n                </View>\n                \n                <View style={styles.featuresContainer}>\n                  {mode.features.map((feature, index) => (\n                    <View key={index} style={styles.featureItem}>\n                      <View style={styles.featureDot} />\n                      <Text style={styles.featureText}>{feature}</Text>\n                    </View>\n                  ))}\n                </View>\n              </LinearGradient>\n            </TouchableOpacity>\n          ))}\n        </View>\n\n        {/* Topic Breakdown */}\n        <View style={styles.section}>\n          <View style={styles.sectionHeader}>\n            <BookOpen size={20} color=\"#4ECDC4\" />\n            <Text style={styles.sectionTitle}>Practice by Topic</Text>\n          </View>\n\n          {topicStats.slice(0, 6).map((topic) => (\n            <TouchableOpacity\n              key={topic.topic}\n              style={styles.topicCard}\n              onPress={() => startTopicPractice(topic.topic)}\n            >\n              <View style={styles.topicHeader}>\n                <View style={styles.topicInfo}>\n                  <Text style={styles.topicName}>{topic.topic}</Text>\n                  <Text style={styles.topicStats}>\n                    {topic.questionsCount} questions â€¢ {topic.accuracy.toFixed(0)}% accuracy\n                  </Text>\n                </View>\n                <View style={styles.topicBadges}>\n                  <View style={[\n                    styles.masteryBadge,\n                    { backgroundColor: getMasteryColor(topic.masteryLevel) }\n                  ]}>\n                    <Text style={styles.masteryText}>\n                      {topic.masteryLevel.charAt(0).toUpperCase() + topic.masteryLevel.slice(1)}\n                    </Text>\n                  </View>\n                  <View style={[\n                    styles.difficultyBadge,\n                    { backgroundColor: getDifficultyColor(topic.difficulty) }\n                  ]}>\n                    <Text style={styles.difficultyBadgeText}>\n                      {topic.difficulty.charAt(0).toUpperCase() + topic.difficulty.slice(1)}\n                    </Text>\n                  </View>\n                </View>\n              </View>\n              \n              <View style={styles.progressContainer}>\n                <View style={styles.progressBar}>\n                  <View style={[\n                    styles.progressFill,\n                    { \n                      width: `${topic.accuracy}%`,\n                      backgroundColor: getMasteryColor(topic.masteryLevel)\n                    }\n                  ]} />\n                </View>\n                <Text style={styles.progressText}>{topic.accuracy.toFixed(0)}%</Text>\n              </View>\n            </TouchableOpacity>\n          ))}\n        </View>\n\n        {/* Quick Actions */}\n        <View style={styles.section}>\n          <Text style={styles.sectionTitle}>Quick Actions</Text>\n          \n          <View style={styles.quickActionsGrid}>\n            <TouchableOpacity \n              style={styles.quickActionCard}\n              onPress={() => router.push('/battle')}\n            >\n              <Swords size={24} color=\"#667eea\" />\n              <Text style={styles.quickActionTitle}>Battle Arena</Text>\n              <Text style={styles.quickActionSubtitle}>Challenge friends</Text>\n            </TouchableOpacity>\n            \n            <TouchableOpacity \n              style={styles.quickActionCard}\n              onPress={() => router.push('/progress')}\n            >\n              <Trophy size={24} color=\"#FF6B35\" />\n              <Text style={styles.quickActionTitle}>Progress</Text>\n              <Text style={styles.quickActionSubtitle}>View analytics</Text>\n            </TouchableOpacity>\n            \n            <TouchableOpacity \n              style={styles.quickActionCard}\n              onPress={() => router.push('/leaderboard')}\n            >\n              <Star size={24} color=\"#FFD93D\" />\n              <Text style={styles.quickActionTitle}>Leaderboard</Text>\n              <Text style={styles.quickActionSubtitle}>See rankings</Text>\n            </TouchableOpacity>\n            \n            <TouchableOpacity \n              style={styles.quickActionCard}\n              onPress={() => router.push('/achievements')}\n            >\n              <Award size={24} color=\"#4ECDC4\" />\n              <Text style={styles.quickActionTitle}>Achievements</Text>\n              <Text style={styles.quickActionSubtitle}>Your badges</Text>\n            </TouchableOpacity>\n          </View>\n        </View>\n\n        <View style={{ height: 80 }} />\n      </ScrollView>\n    </SafeAreaView>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#F8FAFC',\n  },\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#F8FAFC',\n  },\n  loadingText: {\n    marginTop: 16,\n    fontSize: 16,\n    color: '#64748B',\n  },\n  scrollView: {\n    flex: 1,\n  },\n  headerGradient: {\n    paddingBottom: 32,\n    paddingHorizontal: 20,\n    borderBottomLeftRadius: 32,\n    borderBottomRightRadius: 32,\n  },\n  header: {\n    paddingTop: 20,\n    alignItems: 'center',\n  },\n  headerTitle: {\n    fontSize: 28,\n    fontWeight: 'bold',\n    color: '#FFFFFF',\n    marginBottom: 8,\n  },\n  headerSubtitle: {\n    fontSize: 16,\n    color: '#E0E7FF',\n    opacity: 0.9,\n    textAlign: 'center',\n    marginBottom: 24,\n  },\n  statsRow: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    backgroundColor: 'rgba(255, 255, 255, 0.15)',\n    borderRadius: 20,\n    paddingVertical: 16,\n    paddingHorizontal: 20,\n  },\n  statItem: {\n    alignItems: 'center',\n    flex: 1,\n  },\n  statNumber: {\n    fontSize: 20,\n    fontWeight: 'bold',\n    color: '#FFFFFF',\n    marginBottom: 4,\n  },\n  statLabel: {\n    fontSize: 12,\n    color: '#E0E7FF',\n    opacity: 0.8,\n  },\n  statDivider: {\n    width: 1,\n    height: 40,\n    backgroundColor: 'rgba(255, 255, 255, 0.2)',\n  },\n  section: {\n    paddingHorizontal: 20,\n    paddingVertical: 24,\n  },\n  sectionHeader: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    marginBottom: 16,\n    gap: 8,\n  },\n  sectionTitle: {\n    fontSize: 20,\n    fontWeight: 'bold',\n    color: '#1E293B',\n  },\n  difficultySelector: {\n    flexDirection: 'row',\n    backgroundColor: '#FFFFFF',\n    borderRadius: 12,\n    padding: 4,\n    gap: 4,\n  },\n  difficultyButton: {\n    flex: 1,\n    paddingVertical: 12,\n    paddingHorizontal: 16,\n    borderRadius: 8,\n    alignItems: 'center',\n  },\n  difficultyButtonActive: {\n    backgroundColor: '#667eea',\n  },\n  difficultyText: {\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#64748B',\n  },\n  difficultyTextActive: {\n    color: '#FFFFFF',\n  },\n  modeCard: {\n    borderRadius: 20,\n    overflow: 'hidden',\n    marginBottom: 16,\n  },\n  modeGradient: {\n    padding: 20,\n  },\n  modeHeader: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    marginBottom: 16,\n    gap: 16,\n  },\n  modeIcon: {\n    width: 48,\n    height: 48,\n    borderRadius: 24,\n    backgroundColor: 'rgba(255, 255, 255, 0.2)',\n    alignItems: 'center',\n    justifyContent: 'center',\n  },\n  modeContent: {\n    flex: 1,\n  },\n  modeTitle: {\n    fontSize: 18,\n    fontWeight: 'bold',\n    color: '#FFFFFF',\n    marginBottom: 4,\n  },\n  modeDescription: {\n    fontSize: 14,\n    color: '#FFFFFF',\n    opacity: 0.9,\n    lineHeight: 20,\n  },\n  playButton: {\n    width: 40,\n    height: 40,\n    borderRadius: 20,\n    backgroundColor: '#FFFFFF',\n    alignItems: 'center',\n    justifyContent: 'center',\n  },\n  featuresContainer: {\n    gap: 8,\n  },\n  featureItem: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 8,\n  },\n  featureDot: {\n    width: 4,\n    height: 4,\n    borderRadius: 2,\n    backgroundColor: '#FFFFFF',\n    opacity: 0.8,\n  },\n  featureText: {\n    fontSize: 12,\n    color: '#FFFFFF',\n    opacity: 0.8,\n  },\n  topicCard: {\n    backgroundColor: '#FFFFFF',\n    borderRadius: 16,\n    padding: 16,\n    marginBottom: 12,\n    shadowColor: '#000',\n    shadowOffset: {\n      width: 0,\n      height: 2,\n    },\n    shadowOpacity: 0.1,\n    shadowRadius: 4,\n    elevation: 3,\n  },\n  topicHeader: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'flex-start',\n    marginBottom: 12,\n  },\n  topicInfo: {\n    flex: 1,\n    marginRight: 12,\n  },\n  topicName: {\n    fontSize: 16,\n    fontWeight: '600',\n    color: '#1E293B',\n    marginBottom: 4,\n  },\n  topicStats: {\n    fontSize: 12,\n    color: '#64748B',\n  },\n  topicBadges: {\n    gap: 6,\n  },\n  masteryBadge: {\n    paddingHorizontal: 8,\n    paddingVertical: 4,\n    borderRadius: 8,\n    alignSelf: 'flex-end',\n  },\n  masteryText: {\n    fontSize: 10,\n    fontWeight: 'bold',\n    color: '#FFFFFF',\n  },\n  difficultyBadge: {\n    paddingHorizontal: 8,\n    paddingVertical: 4,\n    borderRadius: 8,\n    alignSelf: 'flex-end',\n  },\n  difficultyBadgeText: {\n    fontSize: 10,\n    fontWeight: 'bold',\n    color: '#FFFFFF',\n  },\n  progressContainer: {\n    flexDirection: 'row',\n    alignItems: 'center',\n    gap: 12,\n  },\n  progressBar: {\n    flex: 1,\n    height: 6,\n    backgroundColor: '#E2E8F0',\n    borderRadius: 3,\n    overflow: 'hidden',\n  },\n  progressFill: {\n    height: '100%',\n    borderRadius: 3,\n  },\n  progressText: {\n    fontSize: 12,\n    fontWeight: '600',\n    color: '#475569',\n    minWidth: 32,\n  },\n  quickActionsGrid: {\n    flexDirection: 'row',\n    flexWrap: 'wrap',\n    gap: 12,\n  },\n  quickActionCard: {\n    flex: 1,\n    minWidth: (width - 52) / 2,\n    backgroundColor: '#FFFFFF',\n    borderRadius: 16,\n    padding: 16,\n    alignItems: 'center',\n    shadowColor: '#000',\n    shadowOffset: {\n      width: 0,\n      height: 2,\n    },\n    shadowOpacity: 0.1,\n    shadowRadius: 4,\n    elevation: 3,\n  },\n  quickActionTitle: {\n    fontSize: 14,\n    fontWeight: '600',\n    color: '#1E293B',\n    marginTop: 8,\n    marginBottom: 4,\n  },\n  quickActionSubtitle: {\n    fontSize: 12,\n    color: '#64748B',\n    textAlign: 'center',\n  },\n});